---
phase: 09-distribution-packaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - daem0nmcp/mcp_instance.py
  - daem0nmcp/server.py
  - daem0nmcp/__init__.py
  - pyproject.toml
  - installer/__init__.py
  - installer/config_manager.py
  - installer/health_check.py
  - installer/post_install.py
  - tests/test_installer.py
autonomous: true

must_haves:
  truths:
    - "FastMCP server registers as 'DaemonChat' (not 'Daem0nMCP') so it does not collide with DaemonMCP coding server"
    - "Storage paths default to %LOCALAPPDATA%/DaemonChat/ when DAEM0NMCP_STORAGE_PATH is set, isolating from DaemonMCP's per-project .daem0nmcp/ dirs"
    - "installer/config_manager.py can add and remove the daem0nchat entry in claude_desktop_config.json without destroying other MCP server entries"
    - "installer/health_check.py can verify the DaemonChat server responds over stdio transport"
    - "installer/post_install.py can configure Claude Desktop and verify installation in a single invocation"
  artifacts:
    - path: "daem0nmcp/mcp_instance.py"
      provides: "FastMCP server named DaemonChat"
      contains: 'FastMCP("DaemonChat")'
    - path: "installer/config_manager.py"
      provides: "Claude Desktop config read-merge-write operations"
      exports: ["add_daemon_chat", "remove_daemon_chat", "get_claude_config_path"]
    - path: "installer/health_check.py"
      provides: "Post-install server verification"
      exports: ["run_health_check"]
    - path: "installer/post_install.py"
      provides: "CLI entry point for install/uninstall"
      contains: "__main__"
    - path: "tests/test_installer.py"
      provides: "Tests for config_manager and health_check"
      min_lines: 60
  key_links:
    - from: "installer/post_install.py"
      to: "installer/config_manager.py"
      via: "import add_daemon_chat, remove_daemon_chat"
      pattern: "from.*config_manager.*import"
    - from: "installer/post_install.py"
      to: "installer/health_check.py"
      via: "import run_health_check"
      pattern: "from.*health_check.*import"
    - from: "installer/config_manager.py"
      to: "claude_desktop_config.json"
      via: "JSON read-merge-write"
      pattern: "json\\.loads|json\\.dumps"
---

<objective>
Prepare the codebase for co-existence with DaemonMCP and create the shared installer Python modules that both MCPB and Inno Setup distribution tracks will use.

Purpose: DaemonChat must be identifiable as a separate MCP server from DaemonMCP (coding memory), and the installer infrastructure must be ready before packaging.
Output: Renamed server identity, updated project metadata, and three installer modules (config_manager, health_check, post_install) with tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-distribution-packaging/09-RESEARCH.md
@daem0nmcp/mcp_instance.py
@daem0nmcp/server.py
@daem0nmcp/config.py
@daem0nmcp/__init__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename server identity and update project metadata</name>
  <files>daem0nmcp/mcp_instance.py, daem0nmcp/server.py, daem0nmcp/__init__.py, pyproject.toml</files>
  <action>
    1. In `daem0nmcp/mcp_instance.py`: Change `FastMCP("Daem0nMCP")` to `FastMCP("DaemonChat")`. Update module docstring to reference DaemonChat instead of Daem0nMCP.

    2. In `daem0nmcp/server.py`: Update the logger.info message on line 61 from "Daem0nMCP initialized" to "DaemonChat initialized". Update the argparse description from "Daem0nMCP Server" to "DaemonChat Server". Update the startup log message from "Starting Daem0nMCP" to "Starting DaemonChat".

    3. In `daem0nmcp/__init__.py`: Update the module docstring from "Daem0nMCP Core Package" to "DaemonChat - Conversational Memory for Claude Desktop".

    4. In `pyproject.toml`:
       - Change `description` to "DaemonChat - Persistent conversational memory for Claude Desktop"
       - Update `version` to "1.0.0"
       - Update `authors` to `[{name = "DasBluEyedDevil"}]`
       - Update `Homepage` and `Repository` URLs to "https://github.com/DasBluEyedDevil/Daem0n-Chat"
       - Add `daem0nchat = "daem0nmcp.server:main"` to `[project.scripts]` (keep the old `daem0nmcp` entry too for backward compat)
       - Add `installer` optional dependency group: `installer = ["claude-desktop-config>=0.2.0"]`

    Do NOT rename the Python package directory from `daem0nmcp/` -- per research decision, keep package name internally but change identity externally. Do NOT change the DAEM0NMCP_ env prefix -- env vars are isolated per MCP server process.
  </action>
  <verify>
    Run `python -c "from daem0nmcp.mcp_instance import mcp; print(mcp.name)"` and confirm it prints "DaemonChat".
    Run `python -c "import daem0nmcp; print(daem0nmcp.__doc__)"` and confirm it mentions DaemonChat.
  </verify>
  <done>FastMCP server name is "DaemonChat", pyproject.toml has updated metadata and version 1.0.0, both script entry points (daem0nmcp and daem0nchat) are registered.</done>
</task>

<task type="auto">
  <name>Task 2: Create installer config_manager and health_check modules</name>
  <files>installer/__init__.py, installer/config_manager.py, installer/health_check.py</files>
  <action>
    Create the `installer/` directory at project root.

    1. `installer/__init__.py`: Empty init file with docstring "DaemonChat installer utilities."

    2. `installer/config_manager.py`: Claude Desktop configuration management.
       - Function `get_claude_config_path() -> Path`: Returns platform-specific path to `claude_desktop_config.json`. On Windows: `Path.home() / "AppData" / "Roaming" / "Claude" / "claude_desktop_config.json"`. On macOS: `Path.home() / "Library" / "Application Support" / "Claude" / "claude_desktop_config.json"`. On Linux: `Path.home() / ".config" / "Claude" / "claude_desktop_config.json"`.
       - Function `add_daemon_chat(python_path: str, install_dir: str | None = None) -> bool`: Reads existing config (or creates empty `{"mcpServers": {}}`), adds `"daem0nchat"` entry with: `command` = python_path, `args` = `["-m", "daem0nmcp.server"]`, `env` = dict with `DAEM0NMCP_STORAGE_PATH` set to `str(Path.home() / "AppData" / "Local" / "DaemonChat" / "storage")` (use platform-appropriate path), `DAEM0NMCP_QDRANT_PATH` set to similar DaemonChat/qdrant path, `PYTHONUNBUFFERED` = "1". If install_dir is provided, also set `PYTHONPATH` to install_dir's site-packages and `SENTENCE_TRANSFORMERS_HOME` to install_dir/models. Creates parent directories if needed. Writes config with `json.dumps(config, indent=2)`. Returns True if config was modified, False if entry already existed with same values.
       - Function `remove_daemon_chat() -> bool`: Reads config, removes `"daem0nchat"` key from mcpServers if present. Returns True if removed, False if not found.
       - Use Path objects throughout. Handle `FileNotFoundError` gracefully (create new config). Handle JSON decode errors (back up corrupted file, create new).

    3. `installer/health_check.py`: Post-install verification.
       - Function `check_python_importable() -> tuple[bool, str]`: Try importing `daem0nmcp.mcp_instance` and verify `mcp.name == "DaemonChat"`. Return (True, "OK") or (False, error_message).
       - Function `check_storage_writable() -> tuple[bool, str]`: Verify the DaemonChat storage directory can be created and is writable. Create a temp file, delete it.
       - Function `check_config_entry_exists() -> tuple[bool, str]`: Read claude_desktop_config.json via config_manager and verify "daem0nchat" entry exists.
       - Function `run_health_check() -> dict`: Run all checks, return `{"python_importable": (bool, str), "storage_writable": (bool, str), "config_entry": (bool, str), "all_passed": bool}`.
       - Use try/except around each check so one failure doesn't prevent others from running.
  </action>
  <verify>
    Run `python -c "from installer.config_manager import get_claude_config_path; print(get_claude_config_path())"` -- should print a valid path.
    Run `python -c "from installer.health_check import run_health_check; print(run_health_check())"` -- should run without crashing (some checks may fail in dev environment, that is fine).
  </verify>
  <done>installer/config_manager.py provides add/remove/path functions for Claude Desktop config. installer/health_check.py provides 3 independent checks plus a combined run_health_check function.</done>
</task>

<task type="auto">
  <name>Task 3: Create post_install CLI script and tests</name>
  <files>installer/post_install.py, tests/test_installer.py</files>
  <action>
    1. `installer/post_install.py`: CLI entry point for installation/uninstallation.
       - Uses argparse with subcommands:
         - `install`: Takes `--python-path` (default: sys.executable), `--install-dir` (optional), `--skip-health-check` flag. Calls `add_daemon_chat()`, then `run_health_check()` unless skipped. Prints human-readable results to stdout. Exit code 0 on success, 1 on failure.
         - `uninstall`: No arguments needed. Calls `remove_daemon_chat()`. Prints confirmation.
         - `check`: No arguments. Runs `run_health_check()` and prints results.
       - `if __name__ == "__main__"` block for direct script execution.
       - Also support legacy-style args for Inno Setup compatibility: `--install-dir DIR` without subcommand implies install, `--uninstall` without subcommand implies uninstall.
       - All output goes to stdout with clear, non-technical-user-friendly messages (e.g., "DaemonChat has been configured for Claude Desktop!" not "Config entry added to mcpServers dict").

    2. `tests/test_installer.py`: Test the installer modules.
       - Use tmp_path fixture and monkeypatch to avoid touching real Claude Desktop config.
       - `test_get_claude_config_path_returns_path`: Verify function returns a Path.
       - `test_add_daemon_chat_creates_config_from_scratch`: Mock config path to tmp_path, call add_daemon_chat, verify JSON written with daem0nchat entry.
       - `test_add_daemon_chat_preserves_existing_servers`: Write a config with existing "other_server" entry, call add_daemon_chat, verify both entries exist.
       - `test_add_daemon_chat_idempotent`: Call add_daemon_chat twice, verify second call returns False (no change).
       - `test_remove_daemon_chat`: Add then remove, verify entry gone but file still valid JSON.
       - `test_remove_daemon_chat_when_not_present`: Call remove when entry missing, verify returns False.
       - `test_health_check_python_importable`: Call check_python_importable, verify returns (True, "OK") since we can import daem0nmcp in test env.
       - `test_health_check_storage_writable`: Call check_storage_writable (may need to monkeypatch storage path to tmp_path).
       - `test_run_health_check_returns_all_fields`: Call run_health_check, verify dict has all expected keys.
       - Monkeypatch `config_manager.get_claude_config_path` to return tmp_path file for all config tests.

    Run `pytest tests/test_installer.py -v` after creating both files.
  </action>
  <verify>Run `pytest tests/test_installer.py -v` -- all tests pass.</verify>
  <done>post_install.py provides install/uninstall/check CLI. All tests in test_installer.py pass.</done>
</task>

</tasks>

<verification>
1. `python -c "from daem0nmcp.mcp_instance import mcp; assert mcp.name == 'DaemonChat'"` -- passes
2. `python -c "from installer.config_manager import add_daemon_chat, remove_daemon_chat"` -- imports succeed
3. `python -c "from installer.health_check import run_health_check"` -- imports succeed
4. `python -c "from installer.post_install import main"` -- imports succeed (if main function exists)
5. `pytest tests/test_installer.py -v` -- all tests pass
6. `python -m daem0nmcp --help` -- shows "DaemonChat Server" in description
</verification>

<success_criteria>
- FastMCP server name is "DaemonChat" (verified by import + assert)
- pyproject.toml version is 1.0.0 with DaemonChat description and both script entry points
- installer/ directory contains config_manager.py, health_check.py, post_install.py
- config_manager can add/remove daem0nchat from Claude Desktop config without affecting other entries
- health_check runs 3 independent checks and reports results
- post_install.py provides install/uninstall/check CLI subcommands
- All installer tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-distribution-packaging/09-01-SUMMARY.md`
</output>
