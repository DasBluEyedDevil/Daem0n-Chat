---
phase: 09-distribution-packaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - daem0nmcp/mcp_instance.py
  - daem0nmcp/server.py
  - daem0nmcp/__init__.py
  - pyproject.toml
  - installer/__init__.py
  - installer/config_manager.py
  - installer/health_check.py
  - installer/post_install.py
  - installer/model_downloader.py
  - tests/test_installer.py
autonomous: true

must_haves:
  truths:
    - "FastMCP server registers as 'DaemonChat' (not 'Daem0nMCP') so it does not collide with DaemonMCP coding server"
    - "Storage paths default to %LOCALAPPDATA%/DaemonChat/ when DAEM0NMCP_STORAGE_PATH is set, isolating from DaemonMCP's per-project .daem0nmcp/ dirs"
    - "installer/config_manager.py can add and remove the daem0nchat entry in claude_desktop_config.json without destroying other MCP server entries"
    - "installer/health_check.py can verify the DaemonChat server responds over stdio transport"
    - "installer/post_install.py can configure Claude Desktop and verify installation in a single invocation"
    - "installer/model_downloader.py can pre-download the sentence-transformers embedding model with progress reporting"
  artifacts:
    - path: "daem0nmcp/mcp_instance.py"
      provides: "FastMCP server named DaemonChat"
      contains: 'FastMCP("DaemonChat")'
    - path: "installer/config_manager.py"
      provides: "Claude Desktop config management via claude-desktop-config library"
      exports: ["add_daemon_chat", "remove_daemon_chat", "get_claude_config_path"]
    - path: "installer/health_check.py"
      provides: "Post-install server verification"
      exports: ["run_health_check"]
    - path: "installer/post_install.py"
      provides: "CLI entry point for install/uninstall"
      contains: "__main__"
    - path: "installer/model_downloader.py"
      provides: "Embedding model pre-download with progress"
      exports: ["download_model", "is_model_cached"]
    - path: "tests/test_installer.py"
      provides: "Tests for config_manager, health_check, and model_downloader"
      min_lines: 80
  key_links:
    - from: "installer/post_install.py"
      to: "installer/config_manager.py"
      via: "import add_daemon_chat, remove_daemon_chat"
      pattern: "from.*config_manager.*import"
    - from: "installer/post_install.py"
      to: "installer/health_check.py"
      via: "import run_health_check"
      pattern: "from.*health_check.*import"
    - from: "installer/config_manager.py"
      to: "claude-desktop-config library"
      via: "ClaudeDesktopConfig, enable_mcp_server, disable_mcp_server"
      pattern: "from claude_desktop_config import"
    - from: "installer/model_downloader.py"
      to: "huggingface_hub"
      via: "snapshot_download for model caching"
      pattern: "from huggingface_hub import"
---

<objective>
Prepare the codebase for co-existence with DaemonMCP and create the shared installer Python modules that both MCPB and Inno Setup distribution tracks will use.

Purpose: DaemonChat must be identifiable as a separate MCP server from DaemonMCP (coding memory), and the installer infrastructure must be ready before packaging.
Output: Renamed server identity, updated project metadata, and four installer modules (config_manager, health_check, post_install, model_downloader) with tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-distribution-packaging/09-RESEARCH.md
@daem0nmcp/mcp_instance.py
@daem0nmcp/server.py
@daem0nmcp/config.py
@daem0nmcp/__init__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename server identity and update project metadata</name>
  <files>daem0nmcp/mcp_instance.py, daem0nmcp/server.py, daem0nmcp/__init__.py, pyproject.toml</files>
  <action>
    1. In `daem0nmcp/mcp_instance.py`: Change `FastMCP("Daem0nMCP")` to `FastMCP("DaemonChat")`. Update module docstring to reference DaemonChat instead of Daem0nMCP.

    2. In `daem0nmcp/server.py`: Update the logger.info message on line 61 from "Daem0nMCP initialized" to "DaemonChat initialized". Update the argparse description from "Daem0nMCP Server" to "DaemonChat Server". Update the startup log message from "Starting Daem0nMCP" to "Starting DaemonChat".

    3. In `daem0nmcp/__init__.py`: Update the module docstring from "Daem0nMCP Core Package" to "DaemonChat - Conversational Memory for Claude Desktop".

    4. In `pyproject.toml`:
       - Change `description` to "DaemonChat - Persistent conversational memory for Claude Desktop"
       - Update `version` to "1.0.0"
       - Update `authors` to `[{name = "DasBluEyedDevil"}]`
       - Update `Homepage` and `Repository` URLs to "https://github.com/DasBluEyedDevil/Daem0n-Chat"
       - Add `daem0nchat = "daem0nmcp.server:main"` to `[project.scripts]` (keep the old `daem0nmcp` entry too for backward compat)
       - Add `installer` optional dependency group: `installer = ["claude-desktop-config>=0.2.0"]`

    Do NOT rename the Python package directory from `daem0nmcp/` -- per research decision, keep package name internally but change identity externally. Do NOT change the DAEM0NMCP_ env prefix -- env vars are isolated per MCP server process.
  </action>
  <verify>
    Run `python -c "from daem0nmcp.mcp_instance import mcp; print(mcp.name)"` and confirm it prints "DaemonChat".
    Run `python -c "import daem0nmcp; print(daem0nmcp.__doc__)"` and confirm it mentions DaemonChat.
  </verify>
  <done>FastMCP server name is "DaemonChat", pyproject.toml has updated metadata and version 1.0.0, both script entry points (daem0nmcp and daem0nchat) are registered.</done>
</task>

<task type="auto">
  <name>Task 2: Create installer config_manager and health_check modules using claude-desktop-config library</name>
  <files>installer/__init__.py, installer/config_manager.py, installer/health_check.py</files>
  <action>
    Create the `installer/` directory at project root.

    1. `installer/__init__.py`: Empty init file with docstring "DaemonChat installer utilities."

    2. `installer/config_manager.py`: Claude Desktop configuration management using the claude-desktop-config library (per research -- do NOT hand-roll JSON parsing).
       - Import: `from claude_desktop_config import ClaudeDesktopConfig, enable_mcp_server, disable_mcp_server`
       - Import: `from pathlib import Path`
       - Function `get_claude_config_path() -> Path`: Create a `ClaudeDesktopConfig()` instance and return `Path(cdc.path)`. This delegates platform detection to the library (Windows: `%APPDATA%/Claude/claude_desktop_config.json`, macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`, Linux: `~/.config/Claude/claude_desktop_config.json`).
       - Function `add_daemon_chat(python_path: str, install_dir: str | None = None) -> bool`: Uses the claude-desktop-config library pattern from research Example 1:
         ```python
         cdc = ClaudeDesktopConfig()
         config = cdc.read()

         storage_base = Path.home() / "AppData" / "Local" / "DaemonChat"
         env = {
             "DAEM0NMCP_STORAGE_PATH": str(storage_base / "storage"),
             "DAEM0NMCP_QDRANT_PATH": str(storage_base / "qdrant"),
             "PYTHONUNBUFFERED": "1",
         }
         if install_dir:
             env["PYTHONPATH"] = str(Path(install_dir) / "site-packages")
             env["SENTENCE_TRANSFORMERS_HOME"] = str(Path(install_dir) / "models")

         changed = enable_mcp_server(config, "daem0nchat", {
             "command": python_path,
             "args": ["-m", "daem0nmcp.server"],
             "env": env,
         })

         if changed:
             cdc.write(config)
         return changed
         ```
         Use `sys.platform` to determine correct storage path (Windows uses AppData/Local, macOS uses ~/Library/Application Support, Linux uses ~/.local/share). Return True if config was modified, False if entry already existed with same values.
       - Function `remove_daemon_chat() -> bool`: Uses the library's disable_mcp_server:
         ```python
         cdc = ClaudeDesktopConfig()
         config = cdc.read()
         changed = disable_mcp_server(config, "daem0nchat")
         if changed:
             cdc.write(config)
         return changed
         ```
       - Handle `FileNotFoundError` gracefully -- if no config exists, create new via the library. Handle JSON decode errors (back up corrupted file, create new).

    3. `installer/health_check.py`: Post-install verification.
       - Function `check_python_importable() -> tuple[bool, str]`: Try importing `daem0nmcp.mcp_instance` and verify `mcp.name == "DaemonChat"`. Return (True, "OK") or (False, error_message).
       - Function `check_storage_writable() -> tuple[bool, str]`: Verify the DaemonChat storage directory can be created and is writable. Create a temp file, delete it.
       - Function `check_config_entry_exists() -> tuple[bool, str]`: Read claude_desktop_config.json via config_manager and verify "daem0nchat" entry exists.
       - Function `run_health_check() -> dict`: Run all checks, return `{"python_importable": (bool, str), "storage_writable": (bool, str), "config_entry": (bool, str), "all_passed": bool}`.
       - Use try/except around each check so one failure doesn't prevent others from running.
  </action>
  <verify>
    Run `python -c "from installer.config_manager import get_claude_config_path; print(get_claude_config_path())"` -- should print a valid path.
    Run `python -c "from installer.health_check import run_health_check; print(run_health_check())"` -- should run without crashing (some checks may fail in dev environment, that is fine).
  </verify>
  <done>installer/config_manager.py uses claude-desktop-config library (not hand-rolled JSON) for add/remove/path functions. installer/health_check.py provides 3 independent checks plus a combined run_health_check function.</done>
</task>

<task type="auto">
  <name>Task 3: Create post_install CLI script, model downloader, and tests</name>
  <files>installer/post_install.py, installer/model_downloader.py, tests/test_installer.py</files>
  <action>
    1. `installer/post_install.py`: CLI entry point for installation/uninstallation.
       - Uses argparse with subcommands:
         - `install`: Takes `--python-path` (default: sys.executable), `--install-dir` (optional), `--skip-health-check` flag. Calls `add_daemon_chat()`, then `run_health_check()` unless skipped. Prints human-readable results to stdout. Exit code 0 on success, 1 on failure.
         - `uninstall`: No arguments needed. Calls `remove_daemon_chat()`. Prints confirmation.
         - `check`: No arguments. Runs `run_health_check()` and prints results.
       - `if __name__ == "__main__"` block for direct script execution.
       - Also support legacy-style args for Inno Setup compatibility: `--install-dir DIR` without subcommand implies install, `--uninstall` without subcommand implies uninstall.
       - All output goes to stdout with clear, non-technical-user-friendly messages (e.g., "DaemonChat has been configured for Claude Desktop!" not "Config entry added to mcpServers dict").

    2. `installer/model_downloader.py`: Embedding model pre-download with progress reporting.
       - Constant `DEFAULT_MODEL = "nomic-ai/modernbert-embed-base"` (the model used by this project's sentence-transformers).
       - Constant `DEFAULT_MODELS_DIR`: `Path.home() / "AppData" / "Local" / "DaemonChat" / "models"` on Windows (use sys.platform for cross-platform).
       - Function `is_model_cached(model_name: str = DEFAULT_MODEL, models_dir: Path = None) -> bool`: Check if the model directory already exists in the specified models_dir (default: DEFAULT_MODELS_DIR). Use the sentence_transformers cache structure: look for `models--{model_name.replace('/', '--')}` subdirectory with a `snapshots` folder inside it.
       - Function `download_model(model_name: str = DEFAULT_MODEL, models_dir: Path = None, callback: callable = None) -> Path`: Download the model using `huggingface_hub.snapshot_download()`. Set `cache_dir` to models_dir. If callback is provided, call `callback(message: str)` with progress messages like "Downloading model files...", "Download complete." The huggingface_hub library handles resume and caching internally. Return the path to the downloaded model directory. Wrap in try/except and return None with callback("Download failed: {error}") on failure.
       - Function `download_with_console_progress(model_name: str = DEFAULT_MODEL, models_dir: Path = None)`: Convenience wrapper that prints progress to stdout. Calls `download_model()` with a `print` callback. Suitable for use from post_install.py or the Inno Setup post-install hook.
       - `if __name__ == "__main__"` block that calls `download_with_console_progress()`.
       - NOTE for MCPB path: sentence-transformers auto-downloads models on first use, which is acceptable since MCPB is experimental and uv manages the environment. The model_downloader is primarily for the Inno Setup path where we can pre-stage models during build.

    3. `tests/test_installer.py`: Test the installer modules.
       - Use tmp_path fixture and monkeypatch to avoid touching real Claude Desktop config.
       - `test_get_claude_config_path_returns_path`: Verify function returns a Path.
       - `test_add_daemon_chat_creates_config`: Monkeypatch ClaudeDesktopConfig to use tmp_path, call add_daemon_chat, verify the library's enable_mcp_server was called with correct args (use unittest.mock.patch on the library functions).
       - `test_add_daemon_chat_preserves_existing_servers`: Mock the library's read to return a config with existing "other_server" entry, call add_daemon_chat, verify both entries exist in the config passed to write.
       - `test_add_daemon_chat_idempotent`: Mock enable_mcp_server to return False, verify add_daemon_chat returns False (no change).
       - `test_remove_daemon_chat`: Mock disable_mcp_server to return True, verify remove_daemon_chat returns True and write is called.
       - `test_remove_daemon_chat_when_not_present`: Mock disable_mcp_server to return False, verify returns False.
       - `test_health_check_python_importable`: Call check_python_importable, verify returns (True, "OK") since we can import daem0nmcp in test env.
       - `test_health_check_storage_writable`: Call check_storage_writable (monkeypatch storage path to tmp_path).
       - `test_run_health_check_returns_all_fields`: Call run_health_check, verify dict has all expected keys.
       - `test_post_install_integration`: Run `python -c "from installer.post_install import main"` to verify post_install.py imports and wires to config_manager and health_check correctly.
       - `test_model_downloader_is_model_cached_false`: Call is_model_cached with nonexistent dir, verify returns False.
       - `test_model_downloader_is_model_cached_true`: Create the expected directory structure in tmp_path, verify returns True.
       - Monkeypatch `config_manager.ClaudeDesktopConfig` or the relevant library functions for all config tests.

    Run `pytest tests/test_installer.py -v` after creating all files.
  </action>
  <verify>
    Run `pytest tests/test_installer.py -v` -- all tests pass.
    Run `python -c "from installer.post_install import main; from installer.config_manager import add_daemon_chat; from installer.health_check import run_health_check"` -- all imports succeed (verifies post_install wiring to config_manager and health_check).
    Run `python installer/post_install.py check` -- runs health check end-to-end (some checks may fail in dev, that is fine; must not crash).
  </verify>
  <done>post_install.py provides install/uninstall/check CLI. model_downloader.py provides download_model with progress callback and is_model_cached check. All tests in test_installer.py pass including integration verification that post_install wires to config_manager and health_check.</done>
</task>

</tasks>

<verification>
1. `python -c "from daem0nmcp.mcp_instance import mcp; assert mcp.name == 'DaemonChat'"` -- passes
2. `python -c "from installer.config_manager import add_daemon_chat, remove_daemon_chat"` -- imports succeed
3. `python -c "from claude_desktop_config import ClaudeDesktopConfig"` -- library is available (installed via installer extra)
4. `python -c "from installer.health_check import run_health_check"` -- imports succeed
5. `python -c "from installer.post_install import main"` -- imports succeed
6. `python -c "from installer.model_downloader import download_model, is_model_cached"` -- imports succeed
7. `pytest tests/test_installer.py -v` -- all tests pass
8. `python -m daem0nmcp --help` -- shows "DaemonChat Server" in description
</verification>

<success_criteria>
- FastMCP server name is "DaemonChat" (verified by import + assert)
- pyproject.toml version is 1.0.0 with DaemonChat description and both script entry points
- installer/ directory contains config_manager.py, health_check.py, post_install.py, model_downloader.py
- config_manager uses claude-desktop-config library (not hand-rolled JSON) for all config operations
- health_check runs 3 independent checks and reports results
- post_install.py provides install/uninstall/check CLI subcommands
- model_downloader.py can check cache and download model with progress callback
- All installer tests pass including post_install integration verification
</success_criteria>

<output>
After completion, create `.planning/phases/09-distribution-packaging/09-01-SUMMARY.md`
</output>
