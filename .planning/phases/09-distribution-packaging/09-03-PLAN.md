---
phase: 09-distribution-packaging
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - installer/inno/daem0n_chat.iss
  - installer/build_inno.py
  - tests/test_build_inno.py
autonomous: true

must_haves:
  truths:
    - "Inno Setup script installs DaemonChat to user's local AppData (no admin required) with embedded Python, application code, and pre-installed dependencies"
    - "Post-install hook runs installer/post_install.py to configure Claude Desktop automatically"
    - "Uninstall hook removes the daem0nchat entry from Claude Desktop config"
    - "build_inno.py can download python-build-standalone, install dependencies into a staging directory, and prepare all files for Inno Setup compilation"
    - "Paths with spaces in usernames are handled correctly throughout"
  artifacts:
    - path: "installer/inno/daem0n_chat.iss"
      provides: "Inno Setup installer script"
      contains: "[Setup]"
    - path: "installer/build_inno.py"
      provides: "Build orchestrator for Inno Setup"
      contains: "python-build-standalone"
    - path: "tests/test_build_inno.py"
      provides: "Tests for build script functions"
      min_lines: 30
  key_links:
    - from: "installer/inno/daem0n_chat.iss"
      to: "installer/post_install.py"
      via: "[Run] section executes post_install.py"
      pattern: "post_install"
    - from: "installer/inno/daem0n_chat.iss"
      to: "installer/post_install.py"
      via: "[UninstallRun] section executes post_install.py --uninstall"
      pattern: "uninstall"
    - from: "installer/build_inno.py"
      to: "installer/inno/daem0n_chat.iss"
      via: "prepares files that .iss references"
      pattern: "daem0n_chat\\.iss"
---

<objective>
Create the Inno Setup Windows installer as the reliable distribution path for non-technical users on Windows.

Purpose: The Inno Setup installer is the production-ready fallback that works on any Windows machine without developer tools. It bundles an embedded Python runtime, all dependencies, and the application code into a traditional guided wizard installer. Unlike MCPB (which is experimental), Inno Setup is proven and has zero antivirus false-positive issues.
Output: An Inno Setup script (.iss) and a build orchestrator (build_inno.py) that prepares the staging directory for compilation.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-distribution-packaging/09-RESEARCH.md
@.planning/phases/09-distribution-packaging/09-01-SUMMARY.md
@pyproject.toml
@installer/post_install.py
@installer/config_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Inno Setup script</name>
  <files>installer/inno/daem0n_chat.iss</files>
  <action>
    Create `installer/inno/` directory and the Inno Setup script `daem0n_chat.iss`.

    The .iss script must have these sections:

    **[Setup] section:**
    - AppName=DaemonChat
    - AppVersion=1.0.0
    - AppPublisher=DasBluEyedDevil
    - AppPublisherURL=https://github.com/DasBluEyedDevil/Daem0n-Chat
    - DefaultDirName={localappdata}\DaemonChat (NOT Program Files -- avoids UAC)
    - DefaultGroupName=DaemonChat
    - OutputBaseFilename=DaemonChat-1.0.0-Setup
    - Compression=lzma2
    - SolidCompression=yes
    - PrivilegesRequired=lowest (non-admin install)
    - DisableProgramGroupPage=yes
    - UninstallDisplayName=DaemonChat - Conversational Memory

    **[Languages] section:**
    - Name: "english"; MessagesFile: "compiler:Default.isl"

    **[Files] section:**
    - Source: "staging\python\*"; DestDir: "{app}\python"; Flags: recursesubdirs ignoreversion
    - Source: "staging\app\*"; DestDir: "{app}\app"; Flags: recursesubdirs ignoreversion
    - Source: "staging\site-packages\*"; DestDir: "{app}\site-packages"; Flags: recursesubdirs ignoreversion
    - Source: "staging\installer\*"; DestDir: "{app}\installer"; Flags: recursesubdirs ignoreversion

    **[Run] section (post-install):**
    Use this exact pattern -- the double-quoting handles spaces in paths:
    ```
    [Run]
    Filename: "{app}\python\python.exe"; \
      Parameters: """{app}\installer\post_install.py"" install --python-path ""{app}\python\python.exe"" --install-dir ""{app}"""; \
      WorkingDir: "{app}"; \
      Flags: runhidden waituntilterminated; \
      StatusMsg: "Configuring Claude Desktop..."
    ```

    **[UninstallRun] section:**
    ```
    [UninstallRun]
    Filename: "{app}\python\python.exe"; \
      Parameters: """{app}\installer\post_install.py"" uninstall"; \
      WorkingDir: "{app}"; \
      Flags: runhidden waituntilterminated
    ```

    **[Code] section (Pascal script):**
    - Add an `InitializeSetup` function that checks if Claude Desktop is installed by looking for the Claude AppData directory (`ExpandConstant('{userappdata}\Claude')`). If not found, show a message: "Claude Desktop does not appear to be installed. DaemonChat requires Claude Desktop to function. Install Claude Desktop first from https://claude.ai/download, then run this installer again." Return False to abort.
    - This is a soft check (directory existence), not a hard block.

    **Important path safety:** All paths in Parameters use double-quoting to handle spaces in usernames. The `{app}` constant already handles this in Inno Setup, but explicit quoting in Parameters strings is required.
  </action>
  <verify>
    Read the .iss file and verify: [Setup] has PrivilegesRequired=lowest, [Files] references staging directory structure, [Run] calls post_install.py with correct args, [UninstallRun] calls post_install.py uninstall, [Code] checks for Claude Desktop.
  </verify>
  <done>daem0n_chat.iss is a complete Inno Setup script that installs to LocalAppData, runs post_install.py for configuration, runs uninstall hook on removal, and checks for Claude Desktop before installing.</done>
</task>

<task type="auto">
  <name>Task 2: Create Inno Setup build orchestrator and tests</name>
  <files>installer/build_inno.py, tests/test_build_inno.py</files>
  <action>
    1. `installer/build_inno.py`: Build orchestrator that prepares the staging directory for Inno Setup.

    Constants:
    - PYTHON_STANDALONE_VERSION = "3.12" (target Python version)
    - PYTHON_STANDALONE_URL template (platform-specific, e.g., https://github.com/astral-sh/python-build-standalone/releases for Windows x86_64)
    - STAGING_DIR = "installer/inno/staging"
    - CPU_TORCH_INDEX = "https://download.pytorch.org/whl/cpu"

    Functions:
    - `download_python_standalone(staging_dir: Path) -> Path`: Downloads python-build-standalone for Windows x86_64 from GitHub releases. Extracts to staging_dir/python/. Returns path to python.exe. Uses urllib.request for downloading (no extra deps needed). Shows download progress via print statements. If already downloaded, skip. NOTE: This function is for documentation and future use -- the actual URL may need updating at build time. Include a clear comment with the URL pattern and instructions.

    - `install_dependencies(python_exe: Path, site_packages: Path)`: Runs the embedded Python's pip to install project dependencies into site_packages. Critical: uses `--index-url https://download.pytorch.org/whl/cpu` for torch to get CPU-only wheel (~200MB instead of ~2GB). Installs from pyproject.toml's dependencies list. Command pattern: `[python_exe, "-m", "pip", "install", "--target", str(site_packages), "-r", "requirements-dist.txt"]` where requirements-dist.txt is generated from pyproject.toml deps.

    - `copy_application(staging_dir: Path)`: Copies `daem0nmcp/` directory to staging_dir/app/daem0nmcp/ (excluding __pycache__, .pyc, tests). Copies `installer/` directory to staging_dir/installer/ (excluding build output, __pycache__).

    - `download_embedding_model(staging_dir: Path)`: Downloads the sentence-transformers embedding model into staging_dir/models/ using `installer.model_downloader.download_model()`. This pre-stages the model so the Inno Setup installer bundles it and users avoid a ~400MB first-run download.

    - `generate_requirements(output_path: Path)`: Reads pyproject.toml, extracts dependencies list, writes requirements-dist.txt. Adds `--index-url https://download.pytorch.org/whl/cpu` as first line for torch. Adds `--extra-index-url https://pypi.org/simple/` for everything else.

    - `prepare_staging() -> Path`: Orchestrates: create staging dir, download Python, generate requirements, install deps, copy app code, download embedding model. Returns staging dir path.

    - `build(iscc_path: str = None)`: Calls prepare_staging(), then runs Inno Setup compiler (ISCC.exe) on daem0n_chat.iss if iscc_path is provided. If iscc_path is None, try to find ISCC.exe in standard locations (C:\Program Files (x86)\Inno Setup 6\ISCC.exe). If not found, print "Staging directory prepared at installer/inno/staging/. Install Inno Setup 6 from https://jrsoftware.org/isdl.php and compile installer/inno/daem0n_chat.iss manually."

    - `if __name__ == "__main__"` with argparse: `--stage-only` (prepare staging without compiling), `--iscc-path` (path to ISCC.exe), `--clean` (remove staging directory first), `--skip-model` (skip model download for faster iteration).

    2. `tests/test_build_inno.py`: Test the build script utility functions.
    - `test_generate_requirements_includes_cpu_torch`: Call generate_requirements to tmp_path, verify output contains `--index-url https://download.pytorch.org/whl/cpu`.
    - `test_generate_requirements_includes_all_deps`: Verify output contains key dependencies like fastmcp, sqlalchemy, sentence-transformers, qdrant-client.
    - `test_copy_application_excludes_pycache`: Create a mock source with __pycache__ dir, call copy logic, verify __pycache__ not in output.
    - `test_staging_dir_structure`: Verify prepare_staging creates expected subdirectories (python/, app/, site-packages/, installer/). Mock the download and install steps to avoid network calls.

    Run `pytest tests/test_build_inno.py -v` after creating.
  </action>
  <verify>
    Run `python installer/build_inno.py --help` -- shows usage.
    Run `pytest tests/test_build_inno.py -v` -- all tests pass.
  </verify>
  <done>build_inno.py can prepare a staging directory with Python runtime, dependencies, app code, and pre-downloaded embedding model. It can invoke ISCC.exe if available. All build_inno tests pass.</done>
</task>

</tasks>

<verification>
1. `installer/inno/daem0n_chat.iss` exists and contains valid Inno Setup syntax
2. `python installer/build_inno.py --help` runs without error
3. `pytest tests/test_build_inno.py -v` -- all tests pass
4. The .iss [Run] section correctly calls post_install.py with quoted paths
5. The .iss [UninstallRun] section correctly calls post_install.py uninstall
6. build_inno.py uses CPU-only PyTorch index URL
7. build_inno.py includes model pre-download step via model_downloader
</verification>

<success_criteria>
- Inno Setup script installs to {localappdata}\DaemonChat (no admin required)
- Post-install hook configures Claude Desktop via post_install.py
- Uninstall hook removes config entry
- Claude Desktop existence check prevents useless installation
- build_inno.py can prepare staging directory with all needed files including pre-downloaded model
- CPU-only PyTorch is explicitly specified to avoid 2GB CUDA download
- All paths handle spaces in usernames (double-quoted in .iss)
- Build script tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-distribution-packaging/09-03-SUMMARY.md`
</output>
