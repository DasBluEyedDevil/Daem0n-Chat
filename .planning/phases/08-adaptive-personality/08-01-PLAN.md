---
phase: 08-adaptive-personality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - daem0nmcp/style_detect.py
  - daem0nmcp/tools/daem0n_remember.py
  - daem0nmcp/config.py
  - tests/test_daem0n_tools.py
autonomous: true

must_haves:
  truths:
    - "analyze_style(text) returns scores for formality, verbosity, emoji_usage, expressiveness (each 0.0-1.0)"
    - "StyleProfile.update() applies EMA with alpha=0.3 to smooth score updates"
    - "update_user_style_profile() upserts a single style memory per user (tags=['profile','style'], is_permanent=True)"
    - "load_style_profile() retrieves and deserializes the style memory for a user"
    - "Style analysis only runs on user-originated content in daem0n_remember (not claude_said or claude_commitment)"
    - "build_style_guidance() returns None when message_count < 5"
  artifacts:
    - path: "daem0nmcp/style_detect.py"
      provides: "Rule-based communication style analysis with four dimensions"
      exports: ["analyze_style", "StyleProfile", "build_style_guidance", "load_style_profile", "update_user_style_profile"]
    - path: "daem0nmcp/tools/daem0n_remember.py"
      provides: "Style analysis hook for user-originated content"
      contains: "analyze_style"
    - path: "daem0nmcp/config.py"
      provides: "Style EMA alpha and min messages settings"
      contains: "style_ema_alpha"
  key_links:
    - from: "daem0nmcp/tools/daem0n_remember.py"
      to: "daem0nmcp/style_detect.py"
      via: "import and call after emotion detection"
      pattern: "analyze_style|update_user_style_profile"
    - from: "daem0nmcp/style_detect.py"
      to: "daem0nmcp/models.py"
      via: "Memory model for style profile storage"
      pattern: "Memory"
---

<objective>
Create the style detection module and wire it into the memory pipeline.

Purpose: Enable the system to detect and persist user communication style from their messages, building toward adaptive personality. This is the foundation -- detection and storage -- that Plan 02 will consume to generate briefing guidance.

Output: `style_detect.py` module with four-dimension analysis, EMA-based profile updates, upsert storage, and integration into `daem0n_remember`.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-adaptive-personality/08-RESEARCH.md
@.planning/phases/06-conversation-intelligence/06-01-SUMMARY.md

Key codebase files to reference:
@daem0nmcp/emotion_detect.py — Pattern to follow: rule-based text analysis module with frozensets, compiled regex, single public function
@daem0nmcp/tools/daem0n_remember.py — Hook point: style analysis goes AFTER emotion detection, BEFORE storage, same conditional pattern
@daem0nmcp/auto_detect.py — Pattern to follow: validation module structure, Settings integration
@daem0nmcp/config.py — Add style_ema_alpha and style_min_messages_for_guidance settings
@daem0nmcp/models.py — Memory model used for style storage (no changes needed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create style_detect.py module</name>
  <files>daem0nmcp/style_detect.py, daem0nmcp/config.py</files>
  <action>
Create `daem0nmcp/style_detect.py` following the exact structure from the research document (08-RESEARCH.md Pattern 1-5). The module must contain:

**StyleProfile dataclass:**
- Fields: formality (default 0.5), verbosity (default 0.5), emoji_usage (default 0.0), expressiveness (default 0.3), message_count (default 0)
- `update(new_scores: Dict[str, float])` method: applies EMA with alpha from Settings (default 0.3), increments message_count
- `to_dict()` method: returns all fields rounded to 2 decimal places
- `from_dict(data: dict)` classmethod: constructs StyleProfile from dict (for deserialization)

**analyze_style(text: str) -> Dict[str, float]:**
- Returns empty dict for empty/whitespace-only text
- Four dimension scores (each 0.0-1.0):
  - **formality**: Average of 4 signals -- contraction frequency (CONTRACTIONS regex pattern from research), casual abbreviation count (CASUAL_ABBREVIATIONS frozenset from research), lowercase sentence starts, missing final punctuation
  - **verbosity**: Word count mapped to 0.0-1.0 scale (<=3 words=0.0, 4-10=0.2-0.48, 11-30=0.5-0.8, 31+=0.8-1.0)
  - **emoji_usage**: Unicode emoji count via `unicodedata.category()` check for 'So'/'Sk' categories plus explicit emoji range check. Map: 0=0.0, 1=0.4, 2=0.7, 3+=1.0
  - **expressiveness**: Average of 3 signals -- exclamation mark count, ALL CAPS words (reuse CAPS_PATTERN and COMMON_ACRONYMS from emotion_detect.py via import), expressive interjection count (EXPRESSIVE_INTERJECTIONS frozenset from research)

**build_style_guidance(profile: StyleProfile) -> Optional[str]:**
- Returns None if profile.message_count < MIN_MESSAGES_FOR_GUIDANCE (from Settings, default 5)
- Translates numeric scores into qualitative natural-language guidance using threshold buckets (exact thresholds from research Pattern 4)
- Returns None if no guidance parts generated (all dimensions in neutral range)
- Output format: "COMMUNICATION STYLE ADAPTATION:\n- {guidance}\n\nAdapt naturally -- don't announce the adaptation or call attention to it."

**load_style_profile(ctx, user_name: str) -> Optional[StyleProfile]:**
- Queries Memory table for the single style memory: `user_name == user_name, tags contains "profile" and "style"`, limit 1
- Deserializes JSON content into StyleProfile via from_dict()
- Returns None if no style memory found

**update_user_style_profile(ctx, user_name: str, new_scores: dict) -> None:**
- Loads existing profile via load_style_profile (or creates new StyleProfile if None)
- Calls profile.update(new_scores)
- Upserts: finds existing style memory by tags=["profile","style"] + user_name, updates content with JSON-serialized profile, sets updated_at. If not found, creates new Memory with categories=["preference"], tags=["profile","style"], is_permanent=True
- Uses `async with ctx.db_manager.get_session()` pattern matching existing codebase

**Constants at module top (matching research):**
- CONTRACTIONS: compiled regex for common contractions (from research)
- CASUAL_ABBREVIATIONS: frozenset of ~25 casual abbreviations (from research)
- EXPRESSIVE_INTERJECTIONS: frozenset of ~18 interjections (from research)
- _count_emoji(text: str) -> int: helper using unicodedata

**Import pattern:** Use try/except ImportError for relative vs absolute imports, matching emotion_detect.py pattern. Import CAPS_PATTERN and COMMON_ACRONYMS from emotion_detect.py.

**Config additions (config.py):**
Add two new settings to the Settings class:
- `style_ema_alpha: float = Field(default=0.3, ge=0.0, le=1.0)` — EMA smoothing factor
- `style_min_messages_for_guidance: int = Field(default=5, ge=1)` — Minimum messages before generating style guidance

Read these settings in style_detect.py where needed (build_style_guidance, update method).
  </action>
  <verify>
`python -c "from daem0nmcp.style_detect import analyze_style, StyleProfile, build_style_guidance, load_style_profile, update_user_style_profile; print('imports OK')"` succeeds.
`python -c "from daem0nmcp.style_detect import analyze_style; r = analyze_style('hey lol im gonna grab some food btw'); print(r); assert 0 <= r['formality'] <= 0.5, f'casual text should score low formality: {r}'"` passes.
`python -c "from daem0nmcp.config import Settings; s = Settings(); print(s.style_ema_alpha, s.style_min_messages_for_guidance)"` prints `0.3 5`.
  </verify>
  <done>style_detect.py exists with all five public functions/classes. analyze_style returns four-dimension scores. StyleProfile applies EMA updates. Config has style_ema_alpha and style_min_messages_for_guidance settings.</done>
</task>

<task type="auto">
  <name>Task 2: Wire style analysis into daem0n_remember and add tests</name>
  <files>daem0nmcp/tools/daem0n_remember.py, tests/test_daem0n_tools.py</files>
  <action>
**daem0n_remember.py modifications:**

After the emotion detection enrichment block (line ~134, after `tags.append(f"valence:{emotion['valence']}")`) and BEFORE the `result = await ctx.memory_manager.remember(...)` call, add a style analysis block:

```python
# Style analysis -- only for user-originated content (not claude_said/claude_commitment)
if "claude_said" not in tags and "claude_commitment" not in tags:
    try:
        from ..style_detect import analyze_style, update_user_style_profile
    except ImportError:
        from daem0nmcp.style_detect import analyze_style, update_user_style_profile
    style_scores = analyze_style(content)
    if style_scores:
        await update_user_style_profile(ctx, ctx.current_user, style_scores)
```

This fires on every user-originated remember call, updating the EMA profile in the background. It does NOT modify the memory being stored -- it only updates the separate style profile memory.

**Tests to add (in tests/test_daem0n_tools.py):**

Create a new `TestStyleDetection` class with these tests:

1. **test_analyze_style_casual_text**: Input "hey lol im gonna grab food btw" -> formality < 0.5, expressiveness low
2. **test_analyze_style_formal_text**: Input "I would like to formally request information regarding the upcoming schedule." -> formality > 0.7
3. **test_analyze_style_terse_text**: Input "ok" -> verbosity == 0.0 (<=3 words)
4. **test_analyze_style_verbose_text**: Input (40+ word sentence) -> verbosity > 0.7
5. **test_analyze_style_empty_text**: Input "" -> returns empty dict
6. **test_analyze_style_emoji_detection**: Input with 2 emoji characters -> emoji_usage == 0.7
7. **test_analyze_style_expressive**: Input "OMG THIS IS AMAZING!!!" -> expressiveness > 0.5
8. **test_style_profile_ema_update**: Create StyleProfile, update twice with known scores, verify EMA convergence (not instant jump)
9. **test_style_profile_message_count**: Create profile, update 3 times, verify message_count == 3
10. **test_build_style_guidance_below_min**: Profile with message_count=3 -> returns None
11. **test_build_style_guidance_casual_user**: Profile with formality=0.2, message_count=10 -> guidance contains "casual" or "contractions"
12. **test_build_style_guidance_neutral_profile**: Profile with all mid-range scores (0.5), message_count=10 -> returns None (no guidance for neutral)
13. **test_style_analysis_skips_claude_said**: Mock daem0n_remember call with tags=["claude_said"]. Verify update_user_style_profile is NOT called (use unittest.mock.patch)
14. **test_style_profile_serialization**: Create profile, to_dict(), from_dict(), verify roundtrip

Run full test suite to confirm no regressions.
  </action>
  <verify>
`python -m pytest tests/test_daem0n_tools.py -v -k "TestStyleDetection"` -- all 14 tests pass.
`python -m pytest tests/test_daem0n_tools.py -v` -- full test suite passes with no regressions.
  </verify>
  <done>Style analysis is wired into daem0n_remember for user-originated content only. 14 new tests pass covering all four dimensions, EMA behavior, guidance generation thresholds, claude_said exclusion, and serialization roundtrip. No test regressions.</done>
</task>

</tasks>

<verification>
1. `python -c "from daem0nmcp.style_detect import analyze_style, StyleProfile, build_style_guidance"` imports without error
2. `python -m pytest tests/test_daem0n_tools.py -v -k "TestStyleDetection"` -- 14 tests pass
3. `python -m pytest tests/test_daem0n_tools.py -v` -- full suite passes, 0 regressions
4. Grep daem0n_remember.py for "analyze_style" -- exists after emotion detection block
5. Grep daem0n_remember.py for "claude_said" -- guard condition prevents style analysis on Claude's own messages
6. Grep config.py for "style_ema_alpha" -- setting exists with default 0.3
</verification>

<success_criteria>
- style_detect.py exists with analyze_style(), StyleProfile, build_style_guidance(), load_style_profile(), update_user_style_profile()
- analyze_style returns four dimension scores (0.0-1.0 each) for any non-empty text
- EMA update smooths scores (alpha=0.3, not instant replacement)
- Style profile stored as single permanent memory per user with tags=["profile","style"]
- daem0n_remember runs style analysis on user-originated content, skips claude_said/claude_commitment
- Config has style_ema_alpha (0.3) and style_min_messages_for_guidance (5) settings
- 14 new tests pass, 0 regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-adaptive-personality/08-01-SUMMARY.md`
</output>
