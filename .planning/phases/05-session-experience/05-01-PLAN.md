---
phase: 05-session-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - daem0nmcp/temporal.py
  - daem0nmcp/tools/daem0n_briefing.py
  - daem0nmcp/memory.py
  - tests/test_daem0n_tools.py
autonomous: true

must_haves:
  truths:
    - "Briefing response includes greeting_guidance with 1-2 specific items for Claude to reference naturally"
    - "Briefing unresolved_threads and recent_topics include time_ago human-readable strings"
    - "Recall results include time_ago field alongside created_at"
    - "Greeting guidance explicitly instructs Claude NOT to recite all items or say 'according to my records'"
  artifacts:
    - path: "daem0nmcp/temporal.py"
      provides: "_humanize_timedelta utility function"
      exports: ["_humanize_timedelta"]
    - path: "daem0nmcp/tools/daem0n_briefing.py"
      provides: "greeting_guidance field in briefing response"
      contains: "greeting_guidance"
    - path: "daem0nmcp/memory.py"
      provides: "time_ago field in recall results"
      contains: "time_ago"
    - path: "tests/test_daem0n_tools.py"
      provides: "Tests for temporal formatting, greeting guidance, recall enrichment"
  key_links:
    - from: "daem0nmcp/temporal.py"
      to: "daem0nmcp/tools/daem0n_briefing.py"
      via: "import _humanize_timedelta"
      pattern: "from.*temporal.*import.*_humanize_timedelta"
    - from: "daem0nmcp/temporal.py"
      to: "daem0nmcp/memory.py"
      via: "import _humanize_timedelta for recall enrichment"
      pattern: "from.*temporal.*import.*_humanize_timedelta"
    - from: "daem0nmcp/tools/daem0n_briefing.py"
      to: "greeting_guidance in response dict"
      via: "_build_greeting_guidance() called in _build_user_briefing"
      pattern: "_build_greeting_guidance"
---

<objective>
Add temporal context utility, natural greeting guidance, and recall time enrichment.

Purpose: Enable Claude to greet returning users naturally by referencing 1-2 recent items, and provide human-readable temporal context ("3 days ago", "about a month ago") in both briefing and recall responses so Claude can say things like "you mentioned this 3 weeks ago."

Output: `daem0nmcp/temporal.py` utility, enriched briefing with `greeting_guidance` + `time_ago` fields, enriched recall with `time_ago` field, tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-session-experience/05-RESEARCH.md
@daem0nmcp/tools/daem0n_briefing.py
@daem0nmcp/memory.py
@daem0nmcp/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create temporal utility and enrich briefing with greeting guidance and time_ago</name>
  <files>daem0nmcp/temporal.py, daem0nmcp/tools/daem0n_briefing.py</files>
  <action>
**Create `daem0nmcp/temporal.py`** with a single function:

```python
def _humanize_timedelta(dt: datetime) -> str:
```

This converts a datetime to a human-readable relative time string: "today", "yesterday", "3 days ago", "about a week ago", "2 weeks ago", "about a month ago", "3 months ago", "over a year ago". Use Python stdlib `datetime` only -- no external libraries. Handle naive datetimes by assuming UTC. See the research file Pattern 1 for the exact implementation (~20 lines).

**Modify `daem0nmcp/tools/daem0n_briefing.py`:**

1. Import `_humanize_timedelta` from `daem0nmcp.temporal` (use the try/except relative import pattern already established in the file).

2. Add `time_ago` field to every item in `unresolved_threads` (line ~239-243):
   ```python
   "time_ago": _humanize_timedelta(mem.created_at),
   ```
   Keep `days_ago` as well (it's used for numeric comparison in Plan 05-02).

3. Add `time_ago` field to every item in `recent_topics` (line ~258-261):
   ```python
   "time_ago": _humanize_timedelta(mem.created_at),
   ```

4. Add `emotional_time_ago` when emotional context is found (after line ~277):
   Store the `created_at` of the emotion memory and add `"emotional_time_ago": _humanize_timedelta(emotion_mem.created_at)` to the response alongside `emotional_context`.

5. Create `_build_greeting_guidance()` function (see research Pattern 2 for full implementation). This function takes `greeting_name`, `unresolved_threads`, `recent_topics`, `emotional_context`, and `active_routines` as inputs. It:
   - Picks 1-2 items to reference using priority order: fresh concerns (<=7 days) > recent emotional context > unresolved goals > recent topics > active routines
   - Returns guidance text for Claude (NOT the greeting itself)
   - Includes explicit negative instructions: "DO NOT recite all of them", "DO NOT say 'according to my records'"
   - Includes 2-3 example phrases of natural greeting references
   - If no items to reference, returns simple "Greet {name} warmly" guidance

6. Call `_build_greeting_guidance()` at the end of `_build_user_briefing()` (before the return), and add the result as `response["greeting_guidance"]`.

7. In the returning user path of `daem0n_briefing()` (line ~158-169), simplify `identity_hint` to ONLY contain the identity correction flow ("If they correct you, use daem0n_profile(action='switch_user')..."). Move the greeting instruction ("Greet user as {name}") into `greeting_guidance` -- the greeting guidance now handles that job. Keep `identity_hint` as a small safety-net field for identity correction only.
  </action>
  <verify>
Run `python -c "from daem0nmcp.temporal import _humanize_timedelta; from datetime import datetime, timezone, timedelta; now=datetime.now(timezone.utc); print(_humanize_timedelta(now)); print(_humanize_timedelta(now - timedelta(days=3))); print(_humanize_timedelta(now - timedelta(days=45)))"` and confirm it prints "today", "3 days ago", "about a month ago".
  </verify>
  <done>
`daem0nmcp/temporal.py` exists with `_humanize_timedelta()`. Briefing response contains `greeting_guidance` string, `time_ago` on unresolved_threads and recent_topics, and `emotional_time_ago` when emotional context exists. `identity_hint` is reduced to identity correction only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add time_ago to recall results and write tests</name>
  <files>daem0nmcp/memory.py, tests/test_daem0n_tools.py</files>
  <action>
**Modify `daem0nmcp/memory.py`:**

1. Import `_humanize_timedelta` from `daem0nmcp.temporal` at the top of the file (use try/except relative import pattern).

2. In the `recall()` method, add `'time_ago': _humanize_timedelta(mem.created_at)` to BOTH the condensed and full `mem_dict` dictionaries (around lines 1288-1318). Add it right after the `'created_at'` field in both blocks.

**Add tests to `tests/test_daem0n_tools.py`:**

Create a new test class `TestSessionExperience` with these tests:

1. `test_humanize_timedelta_today` -- datetime.now(UTC) returns "today"
2. `test_humanize_timedelta_yesterday` -- now - 1 day returns "yesterday"
3. `test_humanize_timedelta_days` -- now - 5 days returns "5 days ago"
4. `test_humanize_timedelta_weeks` -- now - 14 days returns "2 weeks ago"
5. `test_humanize_timedelta_months` -- now - 45 days returns "about a month ago"
6. `test_humanize_timedelta_years` -- now - 400 days returns "over a year ago"
7. `test_humanize_timedelta_naive_datetime` -- naive datetime (no tzinfo) is handled without error
8. `test_briefing_contains_greeting_guidance` -- Mock a returning user briefing and assert `greeting_guidance` key exists in response and contains the user's greeting name
9. `test_briefing_unresolved_threads_have_time_ago` -- Mock a returning user briefing with unresolved threads and assert each thread dict has a `time_ago` string key
10. `test_briefing_recent_topics_have_time_ago` -- Mock a returning user briefing with recent topics and assert each topic dict has a `time_ago` string key
11. `test_recall_results_have_time_ago` -- Use the existing test infrastructure to call recall and assert each memory in the result has a `time_ago` string field

For the briefing tests (8-10), follow the existing `TestDaem0nBriefing` test patterns -- they use `patch("daem0nmcp.tools.daem0n_briefing.get_user_context")` with mock context objects. See the existing `test_returning_user_briefing` test around line 639 for the pattern.

Run `pytest tests/test_daem0n_tools.py -x -q` to verify all tests pass.
  </action>
  <verify>Run `pytest tests/test_daem0n_tools.py::TestSessionExperience -v` and confirm all 11 tests pass. Also run `pytest tests/test_daem0n_tools.py -x -q` to confirm no regressions in existing tests.</verify>
  <done>
Recall results include `time_ago` field in both condensed and full modes. 11 new tests pass covering temporal formatting, greeting guidance presence, time_ago in briefing fields, and time_ago in recall results. No regressions in existing tests.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from daem0nmcp.temporal import _humanize_timedelta"` -- imports without error
2. `pytest tests/test_daem0n_tools.py::TestSessionExperience -v` -- all 11 tests pass
3. `pytest tests/test_daem0n_tools.py -x -q` -- no regressions
4. Briefing response for returning user contains: `greeting_guidance` (str), `time_ago` on threads and topics
5. Recall response memories contain `time_ago` field
</verification>

<success_criteria>
- _humanize_timedelta correctly formats relative times from "today" through "over N years ago"
- Returning user briefing includes greeting_guidance that mentions 1-2 recent items with natural phrasing instructions
- All temporal data in briefing (unresolved_threads, recent_topics, emotional context) includes time_ago
- All recall results include time_ago alongside created_at
- identity_hint reduced to identity correction only (greeting moved to greeting_guidance)
- 11 new tests pass, 0 regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-session-experience/05-01-SUMMARY.md`
</output>
